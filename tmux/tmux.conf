# Control Sequences: https://www.xfree86.org/4.8.0/ctlseqs.html
# Query supported control sequences with infocmp
# Note to self:
# bind == bind-key
# unbind == unbind-key
# bind-key assumes CTRL combo unless stroke added to global namespace

# recommendation by neovim
set-option -sg escape-time 10

# Import WezTerm environment variables
set-option -ga update-environment " WEZTERM_FOREGROUND_COLOR WEZTERM_BACKGROUND_COLOR"

# This is what TERM will be inside the tmux session
set-option -g default-terminal "screen-256color"
# This tells tmux to enable full colors if TERM outside is xterm-256color
#set-option -g terminal-overrides ",xterm-256color:RGB"
#set-option -ga terminal-overrides ',xterm-256color*:Tc'
# for tmux >=3.2
set -as terminal-features ",screen-256color:Tc:clipboard"
#set-option -ga terminal-overrides ",xterm-256color:Tc"
#set-option -g terminal-overrides ",xterm-256color:RGB"

# Rebind prefix/leader key (caveat: prefix + control-z when running tmux is unrecoverable. <prefix> C-z suspends the client, tmux itself)
unbind C-b
set -g prefix C-space

# Fix problem when starting tmux as many process. Putting tmux in the background could lead to data loss.
unbind C-z

# Mouse can be used to select panes, select windows (by clicking on the status
# bar), resize panes. For default bindings see `tmux list-keys`
set -g mouse on

set -s set-clipboard on
# set -s set-clipboard external

# History memory increased per pane
set-option -g history-limit 100000

# - #S = session name
# - #T = pane title (~/.zshrc sets this to the last/current command)
set-option -g set-titles-string "#S > #T"

set -g status-keys vi
set-window-option -g mode-keys vi


# Add vim bindings for pane nav (with -n, there is no prefix key required, but could lead to keystroke conflicts in vim)
# bind -n C-h select-pane -L
# bind -n C-j select-pane -D
# bind -n C-k select-pane -U
# bind -n C-l select-pane -R
bind C-h select-pane -L
bind C-j select-pane -D
bind C-k select-pane -U
bind C-l select-pane -R

# Add reorder windows keys
bind-key -n C-S-Left swap-window -t -1\; select-window -t -1
bind-key -n C-S-Right swap-window -t +1\; select-window -t +1
bind-key S-Left swap-window -t -1\; select-window -t -1

# CAUTION: TOO EASY TO DO
bind C-x kill-pane


# Tmux Status Line Options
set -g status-position bottom
set -g status-left-length 100
set -g status-right-length 50
set -g status-interval 30

# Style

# WezTerm color integration - use env vars if available, fallback to defaults
%if "#{!=:#{WEZTERM_BACKGROUND_COLOR},}"
set -g @WEZTERM_BG "#{WEZTERM_BACKGROUND_COLOR}"
set -g @WEZTERM_FG "#{WEZTERM_FOREGROUND_COLOR}"
%else
set -g @WEZTERM_BG '#32302f'
set -g @WEZTERM_FG '#ebdbb2'
%endif

# Palette (define once)
set -g @DARK_GRAY '#32302f'
set -g @LIGHT_GRAY '#d5c4a1'
set -g @YELLOW '#d79921'
set -g @OFFSET_GRAY '#32302f'

# Aliases referencing palette (nested)
set -g @BG "#{@DARK_GRAY}"
set -g @FG "#{@LIGHT_GRAY}"
set -g @BUBBLE_BG "#{@YELLOW}"
set -g @BUBBLE_FG "#{@DARK_GRAY}"

# Parent color
set -g status-style "bg=#{E:@BG},fg=#{E:@FG}"

# Left opener wedge: bg = bar bg, fg = bubble bg → wedge draws in yellow
# Debug $ tmux display-message -p '#[bg=#{E:@BUBBLE_BG}]' -> #[bg=yellow]
set -g @lopen "#[bg=#{E:@WEZTERM_BG},fg=#{E:@BUBBLE_BG}]#[bg=#{E:@BUBBLE_BG},fg=#{E:@BUBBLE_FG}]"
set -g @lclose "#[bg=#{E:@BG},fg=#{E:@BUBBLE_BG}]"
set -g @ropen "#[bg=#{E:@BUBBLE_FG},fg=#{E:@BUBBLE_BG}]#[bg=#{E:@BUBBLE_BG},fg=#{E:@BUBBLE_FG}]"
set -g @rclose "#[bg=#{E:@WEZTERM_BG},fg=#{E:@BUBBLE_BG}]"

set -g @git-branch 'zsh -c "cd #{pane_current_path} && pwd"'
#'#(zsh -c "cd #{pane_current_path} && git rev-parse --show-toplevel | xargs basename")'

# Actually define the statusbar using variables defined afore.
set -g status-left '#{E:@lopen}#{host} #{window_name}[#{window_index}]#{E:@lclose} '

# set -g window-status-format '#[fg=green]#I: #W'
set -g status-right ' #{E:@ropen}%H:%M%z %d.%m.%Y#{E:@rclose}'



# Unbind the default 'r' key binding if it exists
unbind r
# Bind 'r' to reload the tmux configuration
bind r source-file ~/.config/tmux/tmux.conf \; display "Reloaded ~/.config/tmux/tmux.conf"


# Active pane border
#set -g pane-active-border-bg blue

# clock
# set-window-option -g clock-mode-colour green #green

# bell
set-window-option -g window-status-bell-style fg=black,bg=red #base02, red

# keys bound in a key table: see tmux list-keys
# default namespace: prefix key table
# -n == -T "root"
# -r means key can be repeated within interval repeat-time

bind-key -r '+' resize-pane -U 10
bind-key -r '-' resize-pane -D 10
bind-key -r '<' resize-pane -L 10
bind-key -r '>' resize-pane -R 10

# v and h are not bound by default, but we never know in the next versions...
unbind-key -T root v
unbind-key -T root h
unbind % # Split vertically
unbind '"' # Split horizontally
# rename illogical, and run cmd to make path as starting point
bind v split-window -h -c "#{pane_current_path}"
bind h split-window -v -c "#{pane_current_path}"
bind -T root S-left prev
bind -T root S-right next
bind-key -T root S-down new-window -c "#{pane_current_path}"

# It is better to bypass tmux copy-paste stuff and hold SHIFT while selecting with mouse
# But this is how to instruct tmux to copy and paste to the system clipboard
# Double LMB Select & Copy (Word)
bind-key -T copy-mode DoubleClick1Pane \
    select-pane \; \
    send-keys -X select-word-no-clear \; \
    send-keys -X copy-pipe-no-clear "xclip -in -sel primary" bind-key -n DoubleClick1Pane \
    select-pane \; \
    copy-mode -M \; \
    send-keys -X select-word-no-clear \; \
    send-keys -X copy-pipe-no-clear "xclip -in -sel primary"

set-option -g word-separators "-,./?%&#_~"

# pane movement
#bind-key j command-prompt -p "join pane from:"  "join-pane -s '%%'"
#bind-key s command-prompt -p "send pane to:"  "join-pane -t '%%'"
bind-key b "break-pane"
bind-key -T root C-a send-keys C-a

# Reload config from repo (not the one in the store); press PREFIX/LEADER-r to reload config
unbind r
bind r source-file ~/devel/nix-dynatrace-macos-flake/configs/tmux/tmux.conf \; display "Reloaded config from ~/devel/nix-dynatrace-macos-flake/configs/tmux/tmux.conf"
set-option -g default-shell /bin/zsh
